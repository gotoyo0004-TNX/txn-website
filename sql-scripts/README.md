# TXN è³‡æ–™åº«é·ç§»è…³æœ¬

æœ¬ç›®éŒ„åŒ…å« TXN äº¤æ˜“æ—¥èªŒç³»çµ±çš„æ‰€æœ‰è³‡æ–™åº«é·ç§»è…³æœ¬ã€‚

## ğŸ“ è…³æœ¬ç›®éŒ„çµæ§‹

```
sql-scripts/
â”œâ”€â”€ migrations/
â”‚   â”œâ”€â”€ 20240825_143000_initial_database_setup.sql     # åˆå§‹è³‡æ–™åº«è¨­ç½® (å·²æ£„ç”¨)
â”‚   â”œâ”€â”€ 20240825_150000_txn_database_structure.sql     # TXN å°ˆç”¨è³‡æ–™è¡¨çµæ§‹
â”‚   â””â”€â”€ 20250825_160000_auth_system_database_update.sql # ğŸ†• ç”¨æˆ¶èªè­‰ç³»çµ±å…¼å®¹æ›´æ–°
â””â”€â”€ README.md
```

## ğŸš€ åŸ·è¡Œé †åº

**é‡è¦ï¼šè«‹æŒ‰ç…§ä»¥ä¸‹é †åºåŸ·è¡Œè…³æœ¬**

### ç¬¬ä¸€æ¬¡å®‰è£
å¦‚æœæ‚¨æ˜¯ç¬¬ä¸€æ¬¡è¨­ç½®è³‡æ–™åº«ï¼š

1. **è·³é** `20240825_143000_initial_database_setup.sql` (å·²æ£„ç”¨)
2. **åŸ·è¡Œ** `20240825_150000_txn_database_structure.sql` (å»ºç«‹åŸºç¤çµæ§‹)
3. **åŸ·è¡Œ** `20250825_160000_auth_system_database_update.sql` (é…åˆèªè­‰ç³»çµ±)

### å¾èˆŠç‰ˆæœ¬å‡ç´š
å¦‚æœæ‚¨å·²ç¶“åŸ·è¡ŒéèˆŠè…³æœ¬ï¼š

1. **ç›´æ¥åŸ·è¡Œ** `20250825_160000_auth_system_database_update.sql`

## ğŸ“‹ æœ€æ–°è…³æœ¬åŠŸèƒ½ (20250825_160000)

### âœ… **å·²å¯¦ä½œåŠŸèƒ½**
- **ç”¨æˆ¶èªè­‰ç³»çµ±å®Œæ•´æ”¯æ´**
  - èˆ‡ `AuthContext.tsx` å®Œå…¨åŒ¹é…çš„è³‡æ–™è¡¨çµæ§‹
  - è‡ªå‹•å»ºç«‹ç”¨æˆ¶è³‡æ–™ (`user_profiles`)
  - é è¨­ç­–ç•¥è‡ªå‹•ç”¢ç”Ÿ

- **å®‰å…¨æ€§å¢å¼·**
  - Row Level Security (RLS) æ”¿ç­–
  - ç”¨æˆ¶è³‡æ–™éš”é›¢ä¿è­·
  - æ¸…é™¤èˆŠæ”¿ç­–ä¸¦é‡æ–°å»ºç«‹

- **è‡ªå‹•åŒ–åŠŸèƒ½**
  - äº¤æ˜“æç›Šè‡ªå‹•è¨ˆç®—
  - é¢¨éšªå›å ±æ¯” (R/R Ratio) è¨ˆç®—
  - ç­–ç•¥çµ±è¨ˆè‡ªå‹•æ›´æ–°
  - `updated_at` æ¬„ä½è‡ªå‹•ç¶­è­·

### ğŸš€ **æº–å‚™ä¸­çš„åŠŸèƒ½**
- **äº¤æ˜“è¨˜éŒ„ç®¡ç†** (ç¬¬äºŒéšæ®µé–‹ç™¼)
  - æ–°å¢/ç·¨è¼¯äº¤æ˜“ Modal è¦–çª—
  - äº¤æ˜“è¡¨å–®çµ„ä»¶
  - CRUD åŠŸèƒ½
  - ç¯©é¸å™¨å’Œæ’åº

- **æ•¸æ“šè¦–è¦ºåŒ–** (ç¬¬ä¸‰éšæ®µé–‹ç™¼)
  - ç¸¾æ•ˆå¿«ç…§è¡¨ (`performance_snapshots`)
  - KPI è¨ˆç®—é‚è¼¯
  - å„€è¡¨æ¿æ•¸æ“šå„ªåŒ–

## ğŸ”§ å¦‚ä½•åŸ·è¡Œè…³æœ¬

### æ–¹æ³• 1: Supabase ç®¡ç†ä»‹é¢
1. ç™»å…¥ [Supabase Dashboard](https://supabase.com/dashboard)
2. é¸æ“‡æ‚¨çš„å°ˆæ¡ˆ
3. é»é¸å·¦å´ "SQL Editor"
4. è¤‡è£½è…³æœ¬å…§å®¹ä¸¦åŸ·è¡Œ

### æ–¹æ³• 2: å‘½ä»¤åˆ— (éœ€è¦ psql)
```bash
# é€£æ¥åˆ°æ‚¨çš„ Supabase è³‡æ–™åº«
psql "postgresql://postgres:[PASSWORD]@[HOST]:5432/postgres"

# åŸ·è¡Œè…³æœ¬
\i sql-scripts/migrations/20250825_160000_auth_system_database_update.sql
```

## âœ… åŸ·è¡Œå¾Œé©—è­‰

åŸ·è¡Œè…³æœ¬å¾Œï¼Œæ‚¨å¯ä»¥é‹è¡Œä»¥ä¸‹æŸ¥è©¢ä¾†é©—è­‰å®‰è£ï¼š

```sql
-- æª¢æŸ¥è³‡æ–™è¡¨å’Œæ”¿ç­–
SELECT * FROM validate_txn_database();

-- æª¢æŸ¥è§¸ç™¼å™¨
SELECT 
    trigger_name,
    event_object_table,
    action_timing,
    event_manipulation
FROM information_schema.triggers 
WHERE trigger_schema = 'public'
AND event_object_table IN ('user_profiles', 'strategies', 'trades', 'performance_snapshots')
ORDER BY event_object_table, trigger_name;
```

## ğŸ” è³‡æ–™è¡¨çµæ§‹èªªæ˜

### `user_profiles` - ç”¨æˆ¶è³‡æ–™è¡¨
- æ“´å±• Supabase Auth çš„ç”¨æˆ¶è³‡æ–™
- åŒ…å« TXN å°ˆç”¨æ¬„ä½ï¼šåˆå§‹è³‡é‡‘ã€å¹£åˆ¥ã€äº¤æ˜“ç¶“é©—ç­‰
- èˆ‡ `AuthContext.tsx` é è¨­å€¼å®Œå…¨åŒ¹é…

### `strategies` - äº¤æ˜“ç­–ç•¥è¡¨
- ç”¨æˆ¶è‡ªå®šç¾©äº¤æ˜“ç­–ç•¥
- è‡ªå‹•è¨ˆç®—çµ±è¨ˆæ•¸æ“šï¼ˆå‹ç‡ã€å¹³å‡æç›Šç­‰ï¼‰
- æ–°ç”¨æˆ¶æœƒè‡ªå‹•ç²å¾— 3 å€‹é è¨­ç­–ç•¥

### `trades` - äº¤æ˜“è¨˜éŒ„è¡¨
- æ ¸å¿ƒäº¤æ˜“æ•¸æ“šå­˜å„²
- è‡ªå‹•è¨ˆç®—æç›Šå’Œé¢¨éšªå›å ±æ¯”
- æ”¯æ´åŠ å¯†è²¨å¹£ç²¾åº¦ (8 ä½å°æ•¸)

### `performance_snapshots` - ç¸¾æ•ˆå¿«ç…§è¡¨
- ç”¨æ–¼å„€è¡¨æ¿æ€§èƒ½å„ªåŒ–
- æ¯æ—¥ç¸¾æ•ˆæ•¸æ“šå¿«ç…§
- æ¬Šç›Šæ›²ç·šæ•¸æ“šå­˜å„²

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

**1. RLS æ”¿ç­–éŒ¯èª¤**
```sql
-- å¦‚æœé‡åˆ°æ¬Šé™å•é¡Œï¼Œæª¢æŸ¥ RLS æ”¿ç­–
SELECT * FROM pg_policies WHERE schemaname = 'public';
```

**2. è§¸ç™¼å™¨æœªç”Ÿæ•ˆ**
```sql
-- æª¢æŸ¥è§¸ç™¼å™¨ç‹€æ…‹
SELECT * FROM information_schema.triggers 
WHERE trigger_schema = 'public';
```

**3. é è¨­ç­–ç•¥æœªå»ºç«‹**
```sql
-- æ‰‹å‹•ç‚ºç¾æœ‰ç”¨æˆ¶å»ºç«‹é è¨­ç­–ç•¥
SELECT create_default_strategies() FROM auth.users;
```

## ğŸ“ æŠ€è¡“æ”¯æ´

å¦‚æœæ‚¨åœ¨åŸ·è¡Œè…³æœ¬æ™‚é‡åˆ°å•é¡Œï¼š

1. æª¢æŸ¥ Supabase é€£æ¥æ˜¯å¦æ­£å¸¸
2. ç¢ºèªæ‚¨æœ‰è¶³å¤ çš„è³‡æ–™åº«æ¬Šé™
3. æŸ¥çœ‹ Supabase æ—¥èªŒäº†è§£è©³ç´°éŒ¯èª¤
4. åƒè€ƒæœ¬ README çš„æ•…éšœæ’é™¤éƒ¨åˆ†

---

**æœ€å¾Œæ›´æ–°ï¼š2025-08-25**  
**ç‰ˆæœ¬ï¼šv3.0 (Auth System Compatible)**